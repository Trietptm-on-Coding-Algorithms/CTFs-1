<?php

// modulo 66136851568807874928023116761683655862662541154242265872256848676078848644277
//      = 909945816499540334032572139532935351*72682186531972790772877967558905535459827
// lcm(909945816499540334032572139532935351-1, 72682186531972790772877967558905535459827-1)
//      = 11022808594801312488003852793613942631663240779408829259840808090838963374850

// 19787091622775896 = 2^3×83×179×166479535091
$target_num = bchexdec(bin2hex('FLAGPLX'));
echo "Target: $target_num\n";

//$fucking_solution = bcmod(
//    bcpow($target_num, '65537'),
//    '66136851568807874928023116761683655862662541154242265872256848676078848644277'
//);

// (19787091622775896^65537) mod 66136851568807874928023116761683655862662541154242265872256848676078848644277
// = 55211323838976887307186233698415622624152634317526140671311466751200702520036
$fucking_solution = '55211323838976887307186233698415622624152634317526140671311466751200702520036';
echo "Solution: $fucking_solution\n";

execute($fucking_solution);

/*
Target: 19787091622775896
44950212844456690224840967364926980361299115474741976132427291503764555110057
50
2
1690090801071764914955097576963309824451388960507654086159474954444109322980
51
3
28704952153372369130078841833343740896457901926335558742680288438605486893172
52
4
60972662895745428379857402523539096742478690359983413896003175975360636987502
53
5
43567593582703824135057604147410721491175339927073911761181767862580007889801
54
6
37386338040608295604703339500241590736158864295433654478150091067981045146186
55
7
10163619323610038881210915554373572710839126110960096396654731476626948205285
56
8
19602095999442891099425405367074878694907182117573436411301343352146094458168
57
9
17730403849491174286293782109910045668250106666287164324919142708606714029583
469311983782153317283956
cat hi.txt
8335068206667615669059762744360637892266774812833517887255092174593412178622
120143867846560226599008372
cat bye.txt
48141246304264315792739983219046656840990373324519999959442804497545167429363
20814445532709593672116421951
CANIHAZSOME?
*/

//test("FLAGPLX");

/*
test("2");
test("3");
test("4");
test("5");
test("6");
test("7");
test("8");
test("9");
test("cat hi.txt");
test("cat bye.txt");
test("CANIHAZSOME?");
*/

/*execute('2');

execute(bcmod(
    bcpow('19602095999442891099425405367074878694907182117573436411301343352146094458168', '2'),
    '66136851568807874928023116761683655862662541154242265872256848676078848644277'
));*/

//echo bcdiv('9017674130321023709045795108542476858223351201052679362190182616621164166617023255562', '2');

function test($input) {
    $input = rawurlencode($input);
    $url = "http://secretservice.challenges.bsidestlv.com/index.php?action=demo&value=$input";
    $ret = base64_decode(file_get_contents($url));

    echo "$ret\n";
    //$ret = '2';

    execute($ret);
}

function execute($input) {
    $input = rawurlencode(base64_encode($input));
    $url = "http://secretservice.challenges.bsidestlv.com/index.php?action=execute&value=$input";
    //echo "$url\n";
    $ret = file_get_contents($url);

    echo bchexdec(bin2hex($ret)) . "\n";
    echo "$ret\n";
}

// https://stackoverflow.com/questions/1273484/large-hex-values-with-php-hexdec
function bchexdec($hex)
{
    $dec = 0;
    $len = strlen($hex);
    for ($i = 1; $i <= $len; $i++) {
        $dec = bcadd($dec, bcmul(strval(hexdec($hex[$i - 1])), bcpow('16', strval($len - $i))));
    }
    return $dec;
}
